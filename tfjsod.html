<script type="text/html" data-template-name="tensorflowObjDet">
    <div class="form-row">
        <label for="node-input-tensorflowConfig"><i class="fa fa-cog"></i> Model</label>
        <!-- Node-Red will replace this input element by a drop-down (with available Tfjs configurations) -->
        <input type="text" id="node-input-tensorflowConfig">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <button id="node-input-generateConfigNodes"><i class="fa fa-plus-circle"></i> Generate default config nodes</button>
    </div>
    <br>
    <div class="form-row">
        <label for="node-input-scoreThreshold"><i class="fa fa-signal"></i> Threshold</label>
        <input type="number" id="node-input-scoreThreshold" placeholder="e.g. 0 - 1" min="0" max="1" step="0.1">
    </div>
    <div class="form-row" id="node-inputFormat">
        <label for="node-input-outputFormat"><i class="fa fa-picture-o"></i> Input format</label>
        <select type="text" id="node-input-inputFormat" style="width:70%;">
            <option value="jpg">JPEG</option>
            <option value="raw">Raw</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-passthru"><i class="fa fa-picture-o"></i> Passthru</label>
        <select type="text" id="node-input-passthru" style="width:70%;">
            <option value="false">Nothing</option>
            <option value="true">Original Image</option>
            <option value="bbox">Annotated Image</option>
        </select>
    </div>
    <div class="form-row" id="node-outputFormat">
        <label for="node-input-outputFormat"><i class="fa fa-picture-o"></i> Output format</label>
        <select type="text" id="node-input-outputFormat" style="width:70%;">
            <option value="jpg">JPEG</option>
            <option value="raw">Raw</option>
        </select>
    </div>
    <div class="form-row" id="node-bbox-color">
        <label for="node-input-lineColor"><i class="fa fa-paint-brush "></i> Box color</label>
        <input type="color" id="node-input-lineColor" placeholder="HTML5 color or #rrggbb">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/html" data-help-name="tensorflowObjDet">
   <p>A <a href="https://www.tensorflow.org/js" target = "_new">TensorFlow.js</a> node to run Tfjs simple object recognition.</p>
   <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">buffer | string</span></dt>
        <dd>A binary buffer of a jpeg image, or string of a filename to load.</dd>
        <dt>scoreThreshold <span class="property-type">number</span></dt>
        <dd>Minimum threshold for a valid detection (0 - 1)</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">array</span></dt>
        <dd>an array of detected objects, containing :
        <ul><li><code>bbox</code> array, [x,y,width,height]</li>
            <li><code>class</code> string, detected object class</li>
            <li><code>score</code> number, 0 -> 1.</li>
        </ul></dd>
        <dt>classes <span class="property-type">object</span></dt>
        <dd>an object with each class and their counts, e.g. <code>{dog:3,cat:1}</code>.</dd>
        <dt>shape <span class="property-type">array[3]</span></dt>
        <dd>dimensions of the input image, [x,y,depth].</dd>
        <dt>scoreThreshold <span class="property-type">number</span></dt>
        <dd>the scoreThreshold value used in this detection.</dd>
        <dt>image <span class="property-type">buffer</span></dt>
        <dd>(optional) either the original image, or
        the image annotated with detected bounding boxes.</dd>
    </dl>
    <h3>Details</h3>
    <p>The configured scoreThreshold can be overridden dynamically
        by setting the <code>msg.scoreThreshold</code> property.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tensorflowObjDet', {
        category: 'analysis-function',
        defaults: {
            name: { value: "" },
            tensorflowConfig: {value:"", type: "tensorflowObjDetConfig"},
            scoreThreshold: { value: 0.8 },
            inputFormat: { value: "jpg" },
            passthru: { value: "false" },
            lineColor: { value: "#FF00FF" }, // Magenta
            outputFormat: { value: "jpg" }
        },
        inputs: 1,
        outputs: 1,
        paletteLabel: "tf object detect",
        color: "#ED782F",
        icon: "tfjs.png",
        label: function() {
            return this.name || "tf object detect";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;

            function createConfigNode(name, options) {
                var id = RED.nodes.id();

                // Create a new config node
                var newConfig = {
                    id: id,
                    _def: RED.nodes.getType("tensorflowObjDetConfig"),
                    type: "tensorflowObjDetConfig",
                    hasUsers: false,
                    users: [],
                    name: name,
                    label: function() { return this.name || name}
                }

                for(var optionName in options) {
                    newConfig[optionName] = options[optionName];
                }

                RED.nodes.add(newConfig);
                return newConfig;
            }
debugger
            $("#node-input-generateConfigNodes").click(function () {
                var defaultConfigNodes = [];

                // The Tfjs model requires much less properties, because the model contains Js code that parses the output automatically
                var labels1 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Coco SSD Tfjs", {
                    runtime: "tfjs",
                    model: "models/coco-ssd/model.json",
                    modelType: "path",
                    labels: '["' + labels1.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json"
                }));

                var labels2 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","n/a","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","n/a","backpack","umbrella","n/a","n/a","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","n/a","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","n/a","dining table","n/a","n/a","toilet","n/a","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","n/a","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Coco SSD TfLite Coral", {
                    runtime: "tflite",
                    model: "models/coco-coral/tf2_ssd_mobilenet_v2_coco17_ptq_edgetpu.tflite",
                    modelType: "path",
                    labels: '["' + labels2.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 1,
                    bboxPropertyType: "index",
                    classProperty: 3,
                    classPropertyType: "index",
                    scoreProperty: 0,
                    scorePropertyType: "index",
                    countProperty: 2,
                    countPropertyType: "index",
                    bboxFormat: "[y1,x1,y2,x2]",
                    resizeAlgorithm: "neirest"
                }));

                var labels3 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Yolo v5 S", {
                    runtime: "graph",
                    model: "models/yolo5s/model.json",
                    modelType: "path",
                    labels: '["' + labels3.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 0,
                    bboxPropertyType: "index",
                    classProperty: 2,
                    classPropertyType: "index",
                    scoreProperty: 1,
                    scorePropertyType: "index",
                    countProperty: 3,
                    countPropertyType: "index",
                    bboxFormat: "[x1,y1,x2,y2]",
                    resizeAlgorithm: "neirest"
                }));

                var labels4 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Yolo v5 N", {
                    runtime: "graph",
                    model: "models/yolo5n/model.json",
                    modelType: "path",
                    labels: '["' + labels4.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 0,
                    bboxPropertyType: "index",
                    classProperty: 2,
                    classPropertyType: "index",
                    scoreProperty: 1,
                    scorePropertyType: "index",
                    countProperty: 3,
                    countPropertyType: "index",
                    bboxFormat: "[x1,y1,x2,y2]",
                    resizeAlgorithm: "neirest"
                }));

                // Add the new config nodes in the dropdown
                defaultConfigNodes.forEach(function (defaultConfigNode, index) {
                    $("#node-input-tensorflowConfig").append($('<option>', {
                        value: defaultConfigNode.id,
                        text: defaultConfigNode.name
                    }));
                });

                // Make sure the "Coco SSD Tfjs" is selected by default.
                // Otherwise they would only be displayed in the list, the next time this config screen is being openened.
                // TODO check why this doesn't work
                $("#node-input-tensorflowConfig").val("Coco SSD Tfjs").change();
            })

            if (this.lineColor === undefined) {
                $("#node-input-lineColor").val("magenta");
            }
            $("#node-input-passthru").change( function() {
                if ($("#node-input-passthru").val() === "bbox") {
                    $("#node-outputFormat").show();
                    $("#node-bbox-color").show();
                }
                else {
                    $("#node-outputFormat").hide();
                    $("#node-bbox-color").hide();
                }
            });
        }
    });
</script>
